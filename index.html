<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>MoodBoard - App Sections</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        body {
            min-height: 100vh;
        }
        .section-card {
            transition: all 0.3s ease;
        }
        .section-card:hover {
            transform: translateY(-4px);
        }
        .thumbnail-stack {
            position: relative;
            height: 120px;
            width: 100%;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .thumbnail-card {
            position: absolute;
            width: 80px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .thumbnail-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .thumbnail-card:nth-child(1) {
            z-index: 5;
            transform: translateX(-30px) rotate(-3deg);
        }
        .thumbnail-card:nth-child(2) {
            z-index: 4;
            transform: translateX(-15px) rotate(-1.5deg);
        }
        .thumbnail-card:nth-child(3) {
            z-index: 3;
            transform: translateX(0) rotate(0deg);
        }
        .thumbnail-card:nth-child(4) {
            z-index: 2;
            transform: translateX(15px) rotate(1.5deg);
        }
        .thumbnail-card:nth-child(5) {
            z-index: 1;
            transform: translateX(30px) rotate(3deg);
        }
        .section-card:hover .thumbnail-card:nth-child(1) {
            transform: translateX(-35px) rotate(-4deg) translateY(-5px);
        }
        .section-card:hover .thumbnail-card:nth-child(2) {
            transform: translateX(-18px) rotate(-2deg) translateY(-3px);
        }
        .section-card:hover .thumbnail-card:nth-child(3) {
            transform: translateX(0) rotate(0deg) translateY(-5px);
        }
        .section-card:hover .thumbnail-card:nth-child(4) {
            transform: translateX(18px) rotate(2deg) translateY(-3px);
        }
        .section-card:hover .thumbnail-card:nth-child(5) {
            transform: translateX(35px) rotate(4deg) translateY(-5px);
        }
        .item-count-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(168, 142, 72, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            z-index: 1;
        }
        .thumbnail-stack {
            position: relative;
            z-index: 1;
        }
        #auth-modal {
            display: none;
        }
        #auth-modal.show {
            display: flex;
        }
        #admin-overview-modal {
            display: none;
        }
        #admin-overview-modal.show {
            display: flex;
        }
    </style>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#a88e48",
                        "background-light": "#f7f7f6",
                        "background-dark": "#1d1b15",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "Noto Sans", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <!-- Load Supabase config and client -->
    <script src="supabase-config.js"></script>
    <script src="supabase-client.js"></script>
    <!-- Load manifest data for local fallback -->
    <script src="manifest-loader.js"></script>
    <script>
        // Helper function to check if a string is a valid UUID (needed in index.html)
        function isValidUUID(str) {
            if (!str || typeof str !== 'string') return false;
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            return uuidRegex.test(str);
        }
    </script>
</head>
<body class="bg-background-dark font-display">
    <!-- User Authentication Modal -->
    <div id="auth-modal" class="fixed inset-0 z-[3000] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-[#2a271f] rounded-xl border border-[#3e3a2d] w-full max-w-md mx-4">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <img src="SunBurst2.webp" alt="Logo" class="w-12 h-12 object-contain">
                    <h2 class="text-white text-xl font-bold">Welcome to MoodBoard</h2>
                </div>
                <p class="text-white/70 text-sm mb-6">
                    Please enter your name and email to access the design previews. This helps us track feedback and improve the design process.
                </p>
                <form id="auth-form" class="space-y-4">
                    <div>
                        <label for="user-name" class="block text-white/80 text-sm font-medium mb-2">Name</label>
                        <input type="text" id="user-name" required
                               class="w-full px-4 py-3 bg-[#1d1b15] border border-[#3e3a2d] rounded-xl text-white placeholder-white/40 focus:outline-none focus:border-primary"
                               placeholder="Your name">
                    </div>
                    <div>
                        <label for="user-email" class="block text-white/80 text-sm font-medium mb-2">Email</label>
                        <input type="email" id="user-email" required
                               class="w-full px-4 py-3 bg-[#1d1b15] border border-[#3e3a2d] rounded-xl text-white placeholder-white/40 focus:outline-none focus:border-primary"
                               placeholder="your.email@example.com">
                    </div>
                    <button type="submit" 
                            class="w-full h-12 rounded-xl bg-primary text-background-dark font-bold text-base tracking-wide hover:bg-primary/90 transition-colors">
                        Continue
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="min-h-screen pb-8">
        <header id="main-header" class="sticky top-0 z-10 w-full bg-background-dark/80 backdrop-blur-sm border-b border-[#3e3a2d] transition-all duration-300">
            <div id="header-content" class="flex flex-col items-center py-3 px-4 relative transition-all duration-300">
                <img id="header-logo" src="SunBurst2.webp" alt="Logo" class="w-12 h-12 object-contain transition-all duration-300 mb-1">
                <h1 id="header-title" class="text-white text-lg font-bold tracking-tight transition-all duration-300">MoodBoard</h1>
                <!-- User info and logout -->
                <div id="user-info" class="absolute top-2 right-4 hidden">
                    <div class="flex items-center gap-3">
                        <button id="admin-overview-btn" class="hidden flex items-center justify-center h-8 w-8 rounded-full bg-primary/20 hover:bg-primary/30 text-primary transition-colors relative" title="Admin Overview">
                            <span class="material-symbols-outlined text-lg">admin_panel_settings</span>
                        </button>
                        <span id="user-name-display" class="text-white/70 text-xs"></span>
                        <button id="logout-btn" class="text-white/50 hover:text-white text-xs underline" title="Logout">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Disclaimer/Description -->
        <div class="container mx-auto px-4 pt-8 max-w-4xl">
            <div class="bg-[#2a271f] border border-primary/30 rounded-xl p-6 mb-8">
                <div class="flex items-start gap-3 mb-4">
                    <span class="material-symbols-outlined text-primary text-2xl">info</span>
                    <h2 class="text-white text-lg font-bold">Visual Mood Exploration ‚Äî Not Final Designs</h2>
                </div>
                <p class="text-white/80 text-sm leading-relaxed mb-4">
                    These are <strong class="text-white">pre-wireframe visual previews</strong> for vibe-checking and taste direction. They are <strong class="text-white">not finished designs</strong> or final UI/UX work.
                </p>
                <p class="text-white/70 text-sm leading-relaxed mb-4">
                    These mood previews help us understand your preferences for colors, layout styles, tone, and personality <em>before</em> committing to wireframe direction. Think of them as visual references to guide the design process, not designs to be implemented.
                </p>
                <div class="bg-[#1d1b15] border border-[#3e3a2d] rounded-lg p-4 mb-4">
                    <p class="text-white/90 text-sm font-semibold mb-2">üí° As you review, consider:</p>
                    <ul class="text-white/70 text-sm space-y-1.5 list-disc list-inside">
                        <li>What do you like about these previews?</li>
                        <li>What feels wrong or off-brand?</li>
                        <li>Are any colors or layouts catching your eye?</li>
                        <li>Which ones feel closest to your brand's vibe?</li>
                    </ul>
                </div>
                <div class="bg-primary/10 border border-primary/30 rounded-lg p-4">
                    <div class="flex items-start gap-3 mb-2">
                        <span class="material-symbols-outlined text-primary text-xl">rate_review</span>
                        <div class="flex-1">
                            <p class="text-white/90 text-sm font-semibold mb-1">How to Leave Feedback</p>
                            <p class="text-white/70 text-xs leading-relaxed">
                                When viewing any design, click the <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-white/10 text-white text-xs mx-1">üìù</span> notes button in the top-right corner to:
                            </p>
                            <ul class="text-white/70 text-xs space-y-1 mt-2 list-disc list-inside">
                                <li>Rate the design (1-10)</li>
                                <li>Give a quick thumbs up or down</li>
                                <li>Add detailed notes and observations</li>
                            </ul>
                            <p class="text-white/60 text-xs mt-2 italic">
                                Your feedback is saved automatically and helps guide the design direction.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <main class="container mx-auto px-4 py-8 max-w-6xl">
            <div id="sections-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Sections will be loaded dynamically -->
            </div>
        </main>
    </div>

    <!-- Admin Overview Modal -->
    <div id="admin-overview-modal" class="fixed inset-0 z-[3000] hidden items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-[#2a271f] rounded-xl border border-[#3e3a2d] w-full max-w-6xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-[#2a271f] border-b border-[#3e3a2d] p-4 flex items-center justify-between z-10">
                <h3 class="text-white text-xl font-bold">Admin Overview - All Feedback</h3>
                <div class="flex items-center gap-2">
                    <button id="refresh-overview-btn" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white font-semibold rounded-lg transition-colors flex items-center gap-2" title="Refresh feedback">
                        <span class="material-symbols-outlined text-lg">refresh</span>
                        Refresh
                    </button>
                    <button id="export-all-feedback-btn" class="px-4 py-2 bg-primary text-background-dark font-semibold rounded-lg hover:bg-primary/90 transition-colors">
                        Export All Pages
                    </button>
                    <button id="close-overview-modal" class="flex items-center justify-center h-8 w-8 rounded-full bg-white/10 hover:bg-white/20 text-white transition-colors">
                        <span class="material-symbols-outlined text-xl">close</span>
                    </button>
                </div>
            </div>
            <div id="admin-overview-content" class="p-6">
                <div class="flex items-center justify-center py-8">
                    <p class="text-white/60">Loading all feedback...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication and load sections
        async function initApp() {
            console.log('initApp called');
            console.log('isAuthenticated function exists:', typeof isAuthenticated === 'function');
            
            // Check if user is authenticated (with fallback if function doesn't exist)
            const authenticated = typeof isAuthenticated === 'function' ? isAuthenticated() : false;
            console.log('User authenticated:', authenticated);
            
            if (!authenticated) {
                console.log('User not authenticated, showing auth modal');
                document.getElementById('auth-modal').classList.add('show');
                return;
            }

            // User is authenticated, hide modal and load sections
            console.log('User authenticated, loading sections');
            document.getElementById('auth-modal').classList.remove('show');
            await loadSections();
            // Update user info to show admin button if applicable
            updateUserInfo();
        }

        async function loadSections() {
            console.log('loadSections called');
            try {
                // Try to fetch from Supabase first
                console.log('Attempting to fetch from Supabase...');
                let sections = await fetchSections();
                console.log('Supabase fetch result:', sections);
                
                if (sections && sections.length > 0) {
                    console.log(`Found ${sections.length} sections from Supabase`);
                    // Transform Supabase data to match expected format
                    sections = sections.map(s => ({
                        name: s.name,
                        folder: s.folder_path,
                        icon: s.icon,
                        display_order: s.display_order || 999,
                        category: s.category || 'other'
                    }));
                    console.log('Rendering sections from Supabase:', sections);
                    renderSections(sections);
                    return;
                } else {
                    console.log('No sections from Supabase, trying fallback...');
                }
            } catch (error) {
                console.error('Error fetching from Supabase:', error);
                // Continue to fallback
            }

            // Fallback: Try embedded data or scan local Sections folder
            console.log('Trying fallback methods...');
            console.log('sectionsData available:', typeof sectionsData !== 'undefined');
            if (typeof sectionsData !== 'undefined' && sectionsData.sections) {
                console.log('sectionsData.sections:', sectionsData.sections);
            }
            console.log('allManifests available:', typeof allManifests !== 'undefined');
            if (typeof allManifests !== 'undefined') {
                console.log('allManifests keys:', Object.keys(allManifests));
            }
            
            try {
                if (typeof sectionsData !== 'undefined' && sectionsData.sections) {
                    console.log(`Found ${sectionsData.sections.length} sections in embedded data`);
                    // Add default order and category to embedded sections
                    const sectionsWithOrder = sectionsData.sections.map(s => {
                        const nameLower = s.name.toLowerCase();
                        const folderLower = (s.folder || '').toLowerCase();
                        let display_order = 999;
                        let category = 'other';
                        
                        if ('onboarding' in nameLower || 'onboarding' in folderLower) {
                            display_order = 1; category = 'entry';
                        } else if (('home' in nameLower && ('dashboard' in nameLower || 'guest' in nameLower)) || 
                                   ('home' in nameLower || 'dashboard' in nameLower)) {
                            display_order = 2; category = 'entry';
                        } else if ('browse' in nameLower && 'merch' in nameLower) {
                            display_order = 11; category = 'browsing';
                        } else if ('product' in nameLower && 'gallery' in nameLower) {
                            display_order = 12; category = 'browsing';
                        } else if ('product' in nameLower && ('detail' in nameLower || 'page' in nameLower)) {
                            display_order = 31; category = 'product';
                        } else if ('merch' in nameLower && ('item' in nameLower || 'page' in nameLower)) {
                            display_order = 32; category = 'product';
                        } else if ('where' in nameLower && 'buy' in nameLower) {
                            display_order = 51; category = 'purchase';
                        } else if ('checkout' in nameLower || 'order' in nameLower) {
                            display_order = 52; category = 'purchase';
                        } else if ('event' in nameLower) {
                            display_order = 71; category = 'other';
                        }
                        
                        return {
                            ...s,
                            display_order,
                            category
                        };
                    });
                    renderSections(sectionsWithOrder);
                    return;
                }
                
                // Last resort: Try to build sections from manifest-loader.js
                if (typeof allManifests !== 'undefined') {
                    console.log('Building sections from manifest-loader.js');
                    console.log('allManifests keys:', Object.keys(allManifests));
                    const sectionsFromManifests = [];
                    for (const [folderPath, manifest] of Object.entries(allManifests)) {
                        console.log('Processing section:', folderPath);
                        const sectionName = folderPath.split('/').pop().replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        const nameLower = sectionName.toLowerCase();
                        let display_order = 999;
                        let category = 'other';
                        
                        if ('onboarding' in nameLower) {
                            display_order = 1; category = 'entry';
                        } else if (('home' in nameLower && ('dashboard' in nameLower || 'guest' in nameLower)) || 
                                   ('home' in nameLower || 'dashboard' in nameLower)) {
                            display_order = 2; category = 'entry';
                        } else if ('browse' in nameLower && 'merch' in nameLower) {
                            display_order = 11; category = 'browsing';
                        } else if ('product' in nameLower && 'gallery' in nameLower) {
                            display_order = 12; category = 'browsing';
                        } else if ('product' in nameLower && ('detail' in nameLower || 'page' in nameLower)) {
                            display_order = 31; category = 'product';
                        } else if ('merch' in nameLower && ('item' in nameLower || 'page' in nameLower)) {
                            display_order = 32; category = 'product';
                        } else if ('where' in nameLower && 'buy' in nameLower) {
                            display_order = 51; category = 'purchase';
                        } else if ('checkout' in nameLower || 'order' in nameLower) {
                            display_order = 52; category = 'purchase';
                        } else if ('event' in nameLower) {
                            display_order = 71; category = 'other';
                        }
                        
                        sectionsFromManifests.push({
                            name: sectionName,
                            folder: folderPath,
                            icon: 'folder',
                            display_order,
                            category
                        });
                    }
                    
                    if (sectionsFromManifests.length > 0) {
                        console.log(`Built ${sectionsFromManifests.length} sections from manifests:`, sectionsFromManifests);
                        renderSections(sectionsFromManifests);
                        return;
                    } else {
                        console.log('No sections built from manifests');
                    }
                } else {
                    console.log('allManifests is undefined');
                }
                
                throw new Error('No data source available');
            } catch (error) {
                console.error('Error loading sections:', error);
                document.getElementById('sections-grid').innerHTML = 
                    '<div class="col-span-full text-center text-white/60 p-8">' +
                    '<p class="mb-4">Unable to load sections.</p>' +
                    '<p class="text-sm mb-2">Please run:</p>' +
                    '<code class="block bg-[#1d1b15] p-3 rounded mb-4 text-xs">python3 generate-manifests.py</code>' +
                    '<p class="text-sm">Or configure Supabase for automatic syncing.</p>' +
                    '</div>';
            }
        }

        async function renderSections(sections) {
            console.log('renderSections called with:', sections);
            const grid = document.getElementById('sections-grid');
            
            if (!grid) {
                console.error('sections-grid element not found!');
                return;
            }
            
            if (!sections || sections.length === 0) {
                console.error('No sections to render!');
                grid.innerHTML = '<div class="col-span-full text-center text-white/60 p-8">No sections found</div>';
                return;
            }
            
            grid.innerHTML = '';

            // Group sections by category
            const categories = {
                'entry': { name: 'Entry & Onboarding', sections: [] },
                'browsing': { name: 'Browsing', sections: [] },
                'product': { name: 'Product Details', sections: [] },
                'purchase': { name: 'Purchase Flow', sections: [] },
                'other': { name: 'Other', sections: [] }
            };

            // Sort sections by display_order, then group by category
            sections.sort((a, b) => {
                const orderA = a.display_order || 999;
                const orderB = b.display_order || 999;
                if (orderA !== orderB) return orderA - orderB;
                return (a.name || '').localeCompare(b.name || '');
            });

            // Group sections
            sections.forEach(section => {
                const category = section.category || 'other';
                if (categories[category]) {
                    categories[category].sections.push(section);
                } else {
                    categories['other'].sections.push(section);
                }
            });

            // Render grouped sections
            for (const [categoryKey, categoryData] of Object.entries(categories)) {
                if (categoryData.sections.length === 0) continue;

                // Add category header
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'col-span-full mb-4 mt-8 first:mt-0';
                categoryHeader.innerHTML = `
                    <h2 class="text-white/60 text-sm font-semibold uppercase tracking-wider">${categoryData.name}</h2>
                `;
                grid.appendChild(categoryHeader);

                // Render sections in this category
                for (const section of categoryData.sections) {
                    const sectionCard = document.createElement('a');
                    sectionCard.href = `gallery.html?section=${encodeURIComponent(section.folder)}&name=${encodeURIComponent(section.name)}`;
                    sectionCard.className = 'section-card block';
                    
                    // Try to get thumbnails from Supabase
                    let thumbnails = [];
                    let itemCount = 0;
                    
                    try {
                        const items = await fetchGalleryItems(section.folder);
                        if (items && items.length > 0) {
                            itemCount = items.length;
                            thumbnails = items.slice(0, 5).map(item => item.thumbnail);
                        }
                    } catch (error) {
                        console.log('Could not fetch thumbnails from Supabase:', error);
                    }
                    
                    // Fallback to manifest-loader if Supabase fails
                    if (thumbnails.length === 0 && typeof getManifestForSection === 'function') {
                        const manifest = getManifestForSection(section.folder);
                        if (manifest && manifest.items) {
                            itemCount = manifest.items.length;
                            thumbnails = manifest.items.slice(0, 5).map(item => item.thumbnail);
                        }
                    }
                    
                    // Create thumbnail stack HTML
                    let thumbnailStackHTML = '';
                    if (thumbnails.length > 0) {
                        thumbnailStackHTML = '<div class="thumbnail-stack">';
                        thumbnails.forEach((thumbnail, index) => {
                            thumbnailStackHTML += `
                                <div class="thumbnail-card">
                                    <img src="${thumbnail}" alt="" loading="lazy" 
                                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'80\\' height=\\'120\\'%3E%3Crect fill=\\'%232a271f\\' width=\\'80\\' height=\\'120\\'/%3E%3C/svg%3E'">
                                </div>
                            `;
                        });
                        if (itemCount > 5) {
                            thumbnailStackHTML += `<div class="item-count-badge">+${itemCount - 5}</div>`;
                        }
                        thumbnailStackHTML += '</div>';
                    } else {
                        // Fallback to icon if no thumbnails available
                        thumbnailStackHTML = `
                            <div class="flex items-center justify-center mb-4">
                                <span class="material-symbols-outlined text-primary text-5xl">${section.icon || 'folder'}</span>
                            </div>
                        `;
                    }
                    
                    sectionCard.innerHTML = `
                        <div class="bg-[#2a271f] rounded-xl overflow-hidden border border-[#3e3a2d] hover:border-primary/50 transition-colors p-6 h-full">
                            ${thumbnailStackHTML}
                            <h2 class="text-white text-xl font-bold text-center mb-2">${section.name}</h2>
                            <p class="text-white/60 text-sm text-center">${itemCount > 0 ? `${itemCount} ${itemCount === 1 ? 'page' : 'pages'}` : 'Browse variants'}</p>
                        </div>
                    `;
                    grid.appendChild(sectionCard);
                }
            }
        }

        // Handle authentication form
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            
            if (!name || !email) {
                alert('Please enter both name and email');
                return;
            }
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Loading...';
            submitBtn.disabled = true;
            
            try {
                // Initialize Supabase first
                console.log('Initializing Supabase...');
                if (typeof initSupabase === 'function') {
                    const client = await initSupabase();
                    if (!client) {
                        throw new Error('Failed to initialize Supabase client. Check your Supabase configuration.');
                    }
                    console.log('Supabase initialized successfully');
                }
                
                // Get or create user in Supabase
                console.log('Creating/getting user in Supabase...');
                const user = await getOrCreateUser(name, email);
                
                if (user && user.id && isValidUUID(user.id)) {
                    // User successfully created/retrieved from Supabase
                    console.log('User authenticated with Supabase:', user);
                    setCurrentUser(user);
                    document.getElementById('auth-modal').classList.remove('show');
                    await loadSections();
                    // Update user info to show admin button if applicable
                    updateUserInfo();
                } else {
                    // User creation failed
                    console.error('User creation failed. User object:', user);
                    
                    // Check if Supabase is configured
                    if (typeof SUPABASE_CONFIG === 'undefined' || !SUPABASE_CONFIG.url || !SUPABASE_CONFIG.anonKey) {
                        alert('Supabase is not configured. Please check your configuration.');
                    } else {
                        alert('Unable to create user account in Supabase. Please check:\n1. Your internet connection\n2. Browser console for errors\n3. That RLS policies allow user inserts (run fix-admin-feedback-rls.sql)');
                    }
                    
                    // Don't allow login with local storage - force Supabase
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Authentication error:', error);
                alert('Error authenticating: ' + (error.message || 'Unknown error') + '\n\nPlease check the browser console for details.');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Show user info if authenticated
        function updateUserInfo() {
            const user = getCurrentUser();
            const userInfo = document.getElementById('user-info');
            const userNameDisplay = document.getElementById('user-name-display');
            const adminBtn = document.getElementById('admin-overview-btn');
            
            console.log('updateUserInfo called, user:', user);
            console.log('isAdmin function exists:', typeof isAdmin === 'function');
            
            if (user) {
                userInfo.classList.remove('hidden');
                userNameDisplay.textContent = user.name || user.email || 'User';
                
                // Show admin button if user is admin
                if (typeof isAdmin === 'function') {
                    const adminStatus = isAdmin();
                    console.log('Admin status:', adminStatus, 'User email:', user.email);
                    if (adminStatus) {
                        console.log('Showing admin button');
                        adminBtn.classList.remove('hidden');
                    } else {
                        console.log('Hiding admin button - not admin');
                        adminBtn.classList.add('hidden');
                    }
                } else {
                    console.log('isAdmin function not available');
                    adminBtn.classList.add('hidden');
                }
            } else {
                console.log('No user, hiding user info and admin button');
                userInfo.classList.add('hidden');
                if (adminBtn) adminBtn.classList.add('hidden');
            }
        }

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                logoutUser();
            }
        });

        // Header scroll behavior
        let lastScrollTop = 0;
        function handleHeaderScroll() {
            const header = document.getElementById('main-header');
            const headerContent = document.getElementById('header-content');
            const logo = document.getElementById('header-logo');
            const title = document.getElementById('header-title');
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

            if (scrollTop > 50) {
                // Scrolled down - make header compact (50px)
                header.style.height = '50px';
                headerContent.classList.add('py-1');
                headerContent.classList.remove('py-3');
                logo.classList.add('w-8', 'h-8', 'mb-0');
                logo.classList.remove('w-12', 'h-12', 'mb-1');
                title.classList.add('text-sm', 'hidden');
                title.classList.remove('text-lg');
            } else {
                // At top - show full header
                header.style.height = 'auto';
                headerContent.classList.remove('py-1');
                headerContent.classList.add('py-3');
                logo.classList.remove('w-8', 'h-8', 'mb-0');
                logo.classList.add('w-12', 'h-12', 'mb-1');
                title.classList.remove('text-sm', 'hidden');
                title.classList.add('text-lg');
            }
            lastScrollTop = scrollTop;
        }

        // Admin Overview Functions
        async function openAdminOverview() {
            if (typeof isAdmin === 'function' && !isAdmin()) {
                alert('Admin access required. You must be logged in as gorillaflix@gmail.com');
                return;
            }
            
            document.getElementById('admin-overview-modal').classList.add('show');
            await loadAdminOverview();
        }

        async function loadAdminOverview() {
            const content = document.getElementById('admin-overview-content');
            content.innerHTML = '<div class="flex items-center justify-center py-8"><p class="text-white/60">Loading all feedback...</p></div>';

            if (!supabaseClient) {
                supabaseClient = await initSupabase();
                if (!supabaseClient) {
                    content.innerHTML = '<div class="flex items-center justify-center py-8"><p class="text-white/60">Error: Supabase not available</p></div>';
                    return;
                }
            }

            try {
                // Get all gallery items with their section info
                const { data: allItems, error: itemsError } = await supabaseClient
                    .from('gallery_items')
                    .select('id, name, folder_path, thumbnail_path, section_id, sections!inner(folder_path, name)')
                    .order('name');

                if (itemsError) throw itemsError;

                if (!allItems || allItems.length === 0) {
                    content.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12">
                            <span class="material-symbols-outlined text-6xl text-white/30 mb-4">inbox</span>
                            <p class="text-white/60 text-lg">No items found</p>
                            <p class="text-white/40 text-sm mt-2">No gallery items in the database</p>
                        </div>
                    `;
                    return;
                }

                // Get all feedback
                const { data: allFeedback, error: feedbackError } = await supabaseClient
                    .from('feedback')
                    .select('id, item_id, user_id, rating, thumbs, notes, created_at')
                    .order('created_at', { ascending: false });

                if (feedbackError) throw feedbackError;

                // Get all user IDs from feedback
                const userIds = [...new Set((allFeedback || []).map(f => f.user_id).filter(id => id))];
                
                // Get user info
                let usersMap = {};
                if (userIds.length > 0) {
                    const { data: users, error: usersError } = await supabaseClient
                        .from('users')
                        .select('id, name, email')
                        .in('id', userIds);
                    
                    if (!usersError && users) {
                        users.forEach(user => {
                            usersMap[user.id] = user;
                        });
                    }
                }

                // Group feedback by item
                const feedbackByItem = {};
                (allFeedback || []).forEach(feedback => {
                    if (!feedbackByItem[feedback.item_id]) {
                        feedbackByItem[feedback.item_id] = [];
                    }
                    feedbackByItem[feedback.item_id].push({
                        ...feedback,
                        users: usersMap[feedback.user_id] || { id: feedback.user_id, name: 'Unknown User', email: '' }
                    });
                });

                // Build HTML
                let html = '<div class="space-y-6">';
                
                // Summary stats
                const totalFeedback = allFeedback ? allFeedback.length : 0;
                const itemsWithFeedback = Object.keys(feedbackByItem).length;
                const avgRating = totalFeedback > 0 
                    ? (allFeedback.reduce((sum, f) => sum + (f.rating || 0), 0) / totalFeedback).toFixed(1)
                    : '0';
                const thumbsUp = allFeedback ? allFeedback.filter(f => f.thumbs === 'up').length : 0;
                const thumbsDown = allFeedback ? allFeedback.filter(f => f.thumbs === 'down').length : 0;

                html += `
                    <div class="bg-[#1d1b15] border border-[#3e3a2d] rounded-xl p-6 mb-6">
                        <h4 class="text-white text-lg font-bold mb-4">Summary</h4>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <div>
                                <p class="text-white/60 text-xs mb-1">Total Feedback</p>
                                <p class="text-white text-2xl font-bold">${totalFeedback}</p>
                            </div>
                            <div>
                                <p class="text-white/60 text-xs mb-1">Pages with Feedback</p>
                                <p class="text-white text-2xl font-bold">${itemsWithFeedback}</p>
                            </div>
                            <div>
                                <p class="text-white/60 text-xs mb-1">Avg Rating</p>
                                <p class="text-white text-2xl font-bold">${avgRating}/10</p>
                            </div>
                            <div>
                                <p class="text-white/60 text-xs mb-1">Thumbs Up</p>
                                <p class="text-white text-2xl font-bold">${thumbsUp}</p>
                            </div>
                            <div>
                                <p class="text-white/60 text-xs mb-1">Thumbs Down</p>
                                <p class="text-white text-2xl font-bold">${thumbsDown}</p>
                            </div>
                        </div>
                    </div>
                `;

                // List items with feedback
                for (const item of allItems) {
                    const itemFeedback = feedbackByItem[item.id] || [];
                    
                    if (itemFeedback.length === 0) continue; // Skip items with no feedback

                    const sectionFolder = item.sections?.folder_path || '';
                    const sectionName = item.sections?.name || '';
                    const itemName = item.name || item.folder_path.split('/').pop().replace(/_/g, ' ');
                    const itemAvgRating = itemFeedback.length > 0
                        ? (itemFeedback.reduce((sum, f) => sum + (f.rating || 0), 0) / itemFeedback.length).toFixed(1)
                        : '0';
                    
                    // Create link to gallery page with item hash to open it directly
                    const itemFolderName = item.folder_path.split('/').pop();
                    const galleryLink = sectionFolder ? `gallery.html?section=${encodeURIComponent(sectionFolder)}&name=${encodeURIComponent(sectionName)}#item-${item.id}` : '#';

                    html += `
                        <div class="bg-[#1d1b15] border border-[#3e3a2d] rounded-xl p-4">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    ${galleryLink !== '#' ? 
                                        `<a href="${galleryLink}" class="text-white font-semibold text-lg mb-1 hover:text-primary transition-colors cursor-pointer block">${escapeHtml(itemName)}</a>` :
                                        `<h4 class="text-white font-semibold text-lg mb-1">${escapeHtml(itemName)}</h4>`
                                    }
                                    <p class="text-white/60 text-sm">${itemFeedback.length} ${itemFeedback.length === 1 ? 'feedback' : 'feedback entries'}</p>
                                    <p class="text-white/50 text-xs mt-1">Avg Rating: ${itemAvgRating}/10</p>
                                </div>
                                <button onclick="exportItemFeedback('${item.id}', '${escapeHtml(itemName)}')" 
                                        class="px-4 py-2 bg-primary text-background-dark font-semibold rounded-lg hover:bg-primary/90 transition-colors text-sm">
                                    Export
                                </button>
                            </div>
                            <div class="space-y-3 max-h-64 overflow-y-auto">
                    `;

                    itemFeedback.slice(0, 5).forEach(feedback => {
                        const user = feedback.users || {};
                        const userName = user.name || user.email || 'Unknown User';
                        const rating = feedback.rating !== null && feedback.rating !== undefined ? feedback.rating : 'N/A';
                        const thumbs = feedback.thumbs ? (feedback.thumbs === 'up' ? 'üëç' : 'üëé') : '';
                        const notes = feedback.notes || 'No notes provided';
                        const date = feedback.created_at ? new Date(feedback.created_at).toLocaleString() : '';

                        html += `
                            <div class="bg-[#2a271f] border border-[#3e3a2d] rounded-lg p-3">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <p class="text-white font-semibold text-sm">${escapeHtml(userName)}</p>
                                        <p class="text-white/60 text-xs">${escapeHtml(user.email || '')}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="flex items-center gap-2">
                                            <span class="text-primary font-bold">${rating}/10</span>
                                            ${thumbs ? `<span>${thumbs}</span>` : ''}
                                        </div>
                                        <p class="text-white/40 text-xs">${date}</p>
                                    </div>
                                </div>
                                <p class="text-white/80 text-sm mt-2 line-clamp-2">${escapeHtml(notes)}</p>
                            </div>
                        `;
                    });

                    if (itemFeedback.length > 5) {
                        html += `<p class="text-white/50 text-xs text-center pt-2">+${itemFeedback.length - 5} more feedback entries</p>`;
                    }

                    html += `
                            </div>
                        </div>
                    `;
                }

                if (itemsWithFeedback === 0) {
                    html = `
                        <div class="flex flex-col items-center justify-center py-12">
                            <span class="material-symbols-outlined text-6xl text-white/30 mb-4">rate_review</span>
                            <p class="text-white/60 text-lg">No feedback yet</p>
                            <p class="text-white/40 text-sm mt-2">Users haven't left any notes for any designs</p>
                        </div>
                    `;
                }

                html += '</div>';
                content.innerHTML = html;

            } catch (error) {
                console.error('Error loading admin overview:', error);
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-8">
                        <p class="text-red-400 mb-4">Error loading feedback</p>
                        <p class="text-white/60 text-sm mb-4">${error.message || 'Unknown error'}</p>
                        <button onclick="loadAdminOverview()" class="px-4 py-2 bg-primary text-background-dark rounded-lg hover:bg-primary/90">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        async function exportItemFeedback(itemId, itemName) {
            try {
                const allFeedback = await getAllFeedbackForItem(itemId);
                if (!allFeedback || allFeedback.length === 0) {
                    alert('No feedback to export for this item');
                    return;
                }

                // Get item thumbnail
                const { data: item } = await supabaseClient
                    .from('gallery_items')
                    .select('thumbnail_path')
                    .eq('id', itemId)
                    .single();

                const thumbnail = item?.thumbnail_path || '';

                // Create HTML export (similar to gallery.html export)
                let htmlExport = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Feedback Export - ${escapeHtml(itemName)}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1d1b15;
            color: #fff;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3e3a2d;
        }
        .thumbnail {
            max-width: 300px;
            margin: 20px auto;
            border-radius: 8px;
            overflow: hidden;
        }
        .thumbnail img {
            width: 100%;
            height: auto;
            display: block;
        }
        .summary {
            background: #2a271f;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .feedback-item {
            background: #2a271f;
            border: 1px solid #3e3a2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .rating-info {
            text-align: right;
        }
        .rating {
            font-size: 24px;
            font-weight: bold;
            color: #a88e48;
        }
        .notes {
            background: #1d1b15;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .meta {
            color: #666;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Feedback Export</h1>
        <h2>${escapeHtml(itemName)}</h2>
        <p class="meta">Exported on ${new Date().toLocaleString()}</p>
    </div>

    ${thumbnail ? `<div class="thumbnail"><img src="${thumbnail}" alt="${escapeHtml(itemName)}" onerror="this.style.display='none'"></div>` : ''}

    <div class="summary">
        <h3>Summary</h3>
        <p>Total Feedback: <strong>${allFeedback.length}</strong></p>
        <p>Average Rating: <strong>${(allFeedback.reduce((sum, f) => sum + (f.rating || 0), 0) / allFeedback.length).toFixed(1)}/10</strong></p>
        <p>Thumbs Up: <strong>${allFeedback.filter(f => f.thumbs === 'up').length}</strong></p>
        <p>Thumbs Down: <strong>${allFeedback.filter(f => f.thumbs === 'down').length}</strong></p>
    </div>
`;

                allFeedback.forEach((feedback) => {
                    const user = feedback.users || {};
                    const userName = user.name || user.email || 'Unknown User';
                    const userEmail = user.email || '';
                    const rating = feedback.rating || 'N/A';
                    const thumbs = feedback.thumbs ? (feedback.thumbs === 'up' ? 'üëç' : 'üëé') : '';
                    const notes = feedback.notes || 'No notes provided';
                    const date = feedback.created_at ? new Date(feedback.created_at).toLocaleString() : '';

                    htmlExport += `
    <div class="feedback-item">
        <div class="feedback-header">
            <div>
                <h3>${escapeHtml(userName)}</h3>
                <p>${escapeHtml(userEmail)}</p>
            </div>
            <div class="rating-info">
                <div class="rating">${rating}/10 ${thumbs}</div>
                <p class="meta">${date}</p>
            </div>
        </div>
        <div class="notes">${escapeHtml(notes)}</div>
    </div>
`;
                });

                htmlExport += `
</body>
</html>
`;

                // Create blob and download
                const blob = new Blob([htmlExport], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `feedback-${itemName.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${Date.now()}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error exporting item feedback:', error);
                alert('Error exporting feedback. Please try again.');
            }
        }

        async function exportAllFeedback() {
            try {
                // Get all items
                const { data: allItems, error: itemsError } = await supabaseClient
                    .from('gallery_items')
                    .select('id, name, folder_path, thumbnail_path')
                    .order('name');

                if (itemsError) throw itemsError;

                // Get all feedback
                const { data: allFeedback, error: feedbackError } = await supabaseClient
                    .from('feedback')
                    .select('id, item_id, user_id, rating, thumbs, notes, created_at')
                    .order('created_at', { ascending: false });

                if (feedbackError) throw feedbackError;

                // Get all users
                const userIds = [...new Set((allFeedback || []).map(f => f.user_id).filter(id => id))];
                let usersMap = {};
                if (userIds.length > 0) {
                    const { data: users, error: usersError } = await supabaseClient
                        .from('users')
                        .select('id, name, email')
                        .in('id', userIds);
                    
                    if (!usersError && users) {
                        users.forEach(user => {
                            usersMap[user.id] = user;
                        });
                    }
                }

                // Group feedback by item
                const feedbackByItem = {};
                (allFeedback || []).forEach(feedback => {
                    if (!feedbackByItem[feedback.item_id]) {
                        feedbackByItem[feedback.item_id] = [];
                    }
                    feedbackByItem[feedback.item_id].push({
                        ...feedback,
                        users: usersMap[feedback.user_id] || { id: feedback.user_id, name: 'Unknown User', email: '' }
                    });
                });

                // Create comprehensive HTML export
                let htmlExport = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>All Feedback Export - ${new Date().toLocaleDateString()}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1d1b15;
            color: #fff;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3e3a2d;
        }
        .summary {
            background: #2a271f;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .item-section {
            background: #2a271f;
            border: 1px solid #3e3a2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .item-header {
            border-bottom: 1px solid #3e3a2d;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .feedback-item {
            background: #1d1b15;
            border: 1px solid #3e3a2d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        .rating {
            font-size: 20px;
            font-weight: bold;
            color: #a88e48;
        }
        .notes {
            background: #2a271f;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 14px;
        }
        .meta {
            color: #888;
            font-size: 11px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Complete Feedback Export</h1>
        <h2>All Pages - All Users</h2>
        <p class="meta">Exported on ${new Date().toLocaleString()}</p>
    </div>

    <div class="summary">
        <h3>Summary</h3>
        <p>Total Feedback Entries: <strong>${allFeedback ? allFeedback.length : 0}</strong></p>
        <p>Pages with Feedback: <strong>${Object.keys(feedbackByItem).length}</strong></p>
        <p>Average Rating: <strong>${allFeedback && allFeedback.length > 0 ? (allFeedback.reduce((sum, f) => sum + (f.rating || 0), 0) / allFeedback.length).toFixed(1) : '0'}/10</strong></p>
        <p>Thumbs Up: <strong>${allFeedback ? allFeedback.filter(f => f.thumbs === 'up').length : 0}</strong></p>
        <p>Thumbs Down: <strong>${allFeedback ? allFeedback.filter(f => f.thumbs === 'down').length : 0}</strong></p>
    </div>
`;

                // Export each item's feedback
                for (const item of allItems) {
                    const itemFeedback = feedbackByItem[item.id] || [];
                    if (itemFeedback.length === 0) continue;

                    const itemName = item.name || item.folder_path.split('/').pop().replace(/_/g, ' ');

                    htmlExport += `
    <div class="item-section">
        <div class="item-header">
            <h2>${escapeHtml(itemName)}</h2>
            <p class="meta">${itemFeedback.length} ${itemFeedback.length === 1 ? 'feedback entry' : 'feedback entries'}</p>
        </div>
`;

                    itemFeedback.forEach((feedback) => {
                        const user = feedback.users || {};
                        const userName = user.name || user.email || 'Unknown User';
                        const userEmail = user.email || '';
                        const rating = feedback.rating || 'N/A';
                        const thumbs = feedback.thumbs ? (feedback.thumbs === 'up' ? 'üëç' : 'üëé') : '';
                        const notes = feedback.notes || 'No notes provided';
                        const date = feedback.created_at ? new Date(feedback.created_at).toLocaleString() : '';

                        htmlExport += `
        <div class="feedback-item">
            <div class="feedback-header">
                <div>
                    <h3>${escapeHtml(userName)}</h3>
                    <p class="meta">${escapeHtml(userEmail)}</p>
                </div>
                <div style="text-align: right;">
                    <div class="rating">${rating}/10 ${thumbs}</div>
                    <p class="meta">${date}</p>
                </div>
            </div>
            <div class="notes">${escapeHtml(notes)}</div>
        </div>
`;
                    });

                    htmlExport += `
    </div>
`;
                }

                htmlExport += `
</body>
</html>
`;

                // Create blob and download
                const blob = new Blob([htmlExport], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `all-feedback-export-${Date.now()}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error exporting all feedback:', error);
                alert('Error exporting all feedback. Please try again.');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Make functions globally accessible
        window.loadAdminOverview = loadAdminOverview;
        window.exportItemFeedback = exportItemFeedback;
        window.exportAllFeedback = exportAllFeedback;

        // Initialize app on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded - initializing app');
            // Wait for Supabase client to initialize
            setTimeout(() => {
                console.log('Calling initApp...');
                initApp();
                // Update user info after a short delay to ensure Supabase client is ready
                setTimeout(() => {
                    updateUserInfo();
                }, 100);
            }, 500);
            
            // Add scroll listener for header
            window.addEventListener('scroll', handleHeaderScroll);
            handleHeaderScroll(); // Initial check
            
            // Admin overview button
            document.getElementById('admin-overview-btn').addEventListener('click', openAdminOverview);
            document.getElementById('close-overview-modal').addEventListener('click', () => {
                document.getElementById('admin-overview-modal').classList.remove('show');
            });
            document.getElementById('refresh-overview-btn').addEventListener('click', loadAdminOverview);
            document.getElementById('export-all-feedback-btn').addEventListener('click', exportAllFeedback);
            
            // Close modal on outside click
            document.getElementById('admin-overview-modal').addEventListener('click', (e) => {
                if (e.target.id === 'admin-overview-modal') {
                    document.getElementById('admin-overview-modal').classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>

